<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <style>
        .form-container {
            max-width: 500px;
            width: 100%;
            padding: 30px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background: white;
            margin: 70px auto;
        }

        main {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            width: 100%;
            padding: 70px 0;
        }

        .error-message {
            color: red;
        }
    </style>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/index.css}">
</head>
<body>
<header>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">스포츠 게시판</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/board/domestic-baseball">국내야구 게시판</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/board/foreign-baseball">해외야구 게시판</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/board/domestic-basketball">국내농구 게시판</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="false">
                        더 보기
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="/board/foreign-basketball">해외농구 게시판</a>
                        <a class="dropdown-item" href="/board/american-football">미식축구 게시판</a>
                        <a class="dropdown-item" href="/board/domestic-soccer">국내축구 게시판</a>
                        <a class="dropdown-item" href="/board/foreign-soccer">해외축구 게시판</a>
                    </div>
                </li>
            </ul>
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        <img src="/images/search.svg" alt="Search" class="icon">
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        <img src="/images/person.svg" alt="Person" class="icon">
                    </a>
                </li>
            </ul>
        </div>
    </nav>
</header>

<main>
    <div class="form-container">
        <form th:action="@{/user/signup}" th:object="${user}" method="post" id="signupForm">
            <div class="form-group">
                <label for="email">이메일</label>
                <div class="input-group">
                    <input type="email" class="form-control" id="email" placeholder="이메일을 입력하세요" th:field="*{email}">
                    <div class="input-group-append">
                        <button class="btn btn-outline-primary auth-button" id="auth-button" type="button" disabled>
                            인증하기
                        </button>
                    </div>
                </div>
                <small class="error-message" id="email-error-message"></small>
                <input type="text" class="form-control mt-2" id="auth-number" placeholder="인증번호">
                <small class="error-message" id="auth-number-error-message"></small>
            </div>
            <div class="form-group">
                <label for="birthdate">생년월일</label>
                <div class="input-group">
                    <input type="date" class="form-control" id="birthdate" placeholder="생년월일을 선택하세요"
                           th:field="*{birthdate}">
                    <div class="input-group-append">
                    </div>
                </div>
                <small class="error-message" id="birthdate-error-message"></small>
            </div>
            <div class="form-group">
                <label for="password">비밀번호</label>
                <input type="password" class="form-control" id="password" name="password"
                       placeholder="비밀번호 (영문, 숫자, 특수문자 조합 8~20자리)" th:field="*{password}">
                <small class="error-message" id="password-error-message"></small>
            </div>
            <div class="form-group">
                <label for="confirm-password">비밀번호 확인</label>
                <input type="password" class="form-control" id="confirm-password" name="confirmPassword"
                       placeholder="비밀번호 확인" th:field="*{confirmPassword}">
                <small class="error-message" id="confirm-password-error-message"></small>
            </div>
            <button type="submit" class="btn btn-primary btn-block" id="signup-button" disabled>회원가입</button>
        </form>
    </div>
</main>

<footer class="footer">
    <div class="container">
        <p>&copy; 2024 게시판 웹사이트. All rights reserved.</p>
        <p>회사 주소 | 전화번호 | 이메일</p>
    </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        jQuery(function($) {
            var isEmailValid = false;
            var isAuthNumberValid = false;
            var isBirthdateValid = false;
            var isPasswordValid = false;
            var isConfirmPasswordValid = false;

            function validateForm() {
                if (isEmailValid && isAuthNumberValid && isBirthdateValid && isPasswordValid && isConfirmPasswordValid) {
                    $('#signup-button').prop('disabled', false);
                } else {
                    $('#signup-button').prop('disabled', true);
                }
            }

            // 인증 이메일 발송
            $('.auth-button').on('click', function() {
                var email = $('#email').val();
                var emailDto = { email: email };
                $.ajax({
                    url: '/mailSend',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(emailDto),
                    dataType: 'json',
                    success: function(response) {
                        alert('인증 이메일이 발송되었습니다.');
                        console.log(response);
                    },
                    error: function(error) {
                        alert('인증 이메일 발송에 실패했습니다.');
                        console.error(error);
                    }
                });
            });

            // 인증번호 확인
            $('#auth-number').on('input', function() {
                var authNum = $(this).val();
                var email = $('#email').val();
                var data = JSON.stringify({ email: email, authNum: authNum });

                if (authNum.length === 6) {
                    $.ajax({
                        url: '/mailauthCheck',
                        type: 'POST',
                        contentType: 'application/json',
                        data: data,
                        success: function(response) {
                            $('#auth-number-error-message').text("인증에 성공하였습니다.");
                            $('#auth-number').prop('disabled', true);
                            isAuthNumberValid = true;
                            validateForm();
                        },
                        error: function(response) {
                            $('#auth-number-error-message').text("인증에 실패하였습니다.");
                            isAuthNumberValid = false;
                            validateForm();
                        }
                    });
                } else {
                    $('#auth-number-error-message').text("");
                    isAuthNumberValid = false;
                    validateForm();
                }
            });

            // 이메일 유효성 및 중복 검사
            $('#email').on('input', function() {
                var email = $(this).val();
                var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    $('#email-error-message').text("이메일 형식이 올바르지 않습니다.");
                    $('.auth-button').prop('disabled', true);
                    isEmailValid = false;
                    validateForm();
                } else {
                    $('#email-error-message').text("");
                    var data = JSON.stringify({ email: email });
                    $.ajax({
                        url: '/mailDuplicationValidation',
                        type: 'POST',
                        contentType: 'application/json',
                        data: data,
                        success: function(response) {
                            $('#email-error-message').text("사용 가능한 이메일입니다.");
                            $('.auth-button').prop('disabled', false);
                            isEmailValid = true;
                            validateForm();
                        },
                        error: function(response) {
                            $('#email-error-message').text("이미 등록된 이메일입니다.");
                            $('.auth-button').prop('disabled', true);
                            isEmailValid = false;
                            validateForm();
                        }
                    });
                }
            });

            // 비밀번호 유효성 검사
            $('#password').on('input', function() {
                var password = $(this).val();
                var passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,20}$/;
                if (!passwordRegex.test(password)) {
                    $('#password-error-message').text("비밀번호는 영문, 숫자, 특수문자를 포함하여 8~20자리여야 합니다.");
                    isPasswordValid = false;
                } else {
                    $('#password-error-message').text("");
                    isPasswordValid = true;
                }
                validateForm();
            });

            // 비밀번호 확인
            $('#confirm-password').on('input', function() {
                var password = $('#password').val();
                var confirmPassword = $(this).val();
                if (password !== confirmPassword) {
                    $('#confirm-password-error-message').text("비밀번호가 일치하지 않습니다.");
                    isConfirmPasswordValid = false;
                } else {
                    $('#confirm-password-error-message').text("");
                    isConfirmPasswordValid = true;
                }
                validateForm();
            });

            // 생년월일 유효성 검사
            function validateBirthdate() {
                var birthdateInput = $('#birthdate').val();
                var birthdateErrorMessage = $('#birthdate-error-message');
                var datePattern = /^\d{4}-\d{2}-\d{2}$/;
                if (!birthdateInput || !datePattern.test(birthdateInput) || isNaN(new Date(birthdateInput).getTime())) {
                    birthdateErrorMessage.text("유효한 날짜를 입력하세요. (예: 1997-03-16)");
                    isBirthdateValid = false;
                } else {
                    birthdateErrorMessage.text("");
                    isBirthdateValid = true;
                }
                validateForm();
            }

            $('#birthdate').on('input', validateBirthdate);

            $('#signupForm').on('submit', function(event) {
                event.preventDefault();

                var formData = {
                    email: $('#email').val(),
                    authNumber: $('#auth-number').val(),
                    password: $('#password').val(),
                    confirmPassword: $('#confirm-password').val(),
                    birthdate: $('#birthdate').val()
                };

                var jsonData = JSON.stringify(formData);

                $.ajax({
                    url: '/user/signup',
                    type: 'POST',
                    contentType: 'application/json',
                    data: jsonData,
                    success: function(response) {
                        alert(response);
                    },
                    error: function(error) {
                        alert(xhr.responseText);
                    }
                });
            });
        });
    });
</script>
</body>
</html>
